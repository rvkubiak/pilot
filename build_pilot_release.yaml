# Used for automated builds triggered on Git tags pushed matching the regex:
#   \d+\.\d+\.\d+

steps:
- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'touch', 'platform/kube/config' ]
  id: "Touch required Kubernetes config"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'mkdir', '-p', '/tmp/gopath/src/istio.io/pilot' ]
  id: "Setup Go workspace"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'bash', '-c', 'ln -s /workspace /tmp/gopath/src/istio.io/pilot' ]
  id: "Symlink Go workspace"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'ls', '-la', '/tmp/gopath/src/istio.io/pilot' ]
  id: "Inspect Go symlink"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'ls', '-lR', '/tmp/gopath' ]
  id: "Inspect Go workspace"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ './bin/upload-istioctl', '-r', '-p', "gs://$PROJECT_ID/pilot/$TAG_NAME" ]
  env: ["GOPATH=/tmp/gopath"]
  id: "Upload istioctl"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'bash', './bin/push-docker', '-hub', "gcr.io/$PROJECT_ID", '-tag', "$TAG_NAME" ]
  id: "Upload container images"

timeout: 1800s
