# Used for automated builds triggered on Git tags pushed matching the regex:
#   \d+\.\d+\.\d+

steps:
- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'touch', 'platform/kube/config' ]
  id: "Touch required Kubernetes config"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'mkdir', '-p', '/gopath/src/istio.io' ]
  id: "Setup Go workspace"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'ln', '-s', '/workspace', '/gopath/src/istio.io/pilot' ]
  entrypoint: [ '/bin/bash' ]
  id: "Symlink Go workspace"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'ls', '-la', '/workspace', '/gopath/src/istio.io/pilot' ]
  id: "Inspect Go symlink"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'ls', '-lR', '/gopath' ]
  id: "Inspect Go workspace"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'exit 1' ]
  id: "Break"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ './bin/upload-istioctl', '-r', '-p', "gs://$PROJECT_ID/pilot/$TAG_NAME" ]
  env: ["GOPATH=/gopath"]
  id: "Upload istioctl"

- name: 'gcr.io/$PROJECT_ID/istio-builder'
  args: [ 'bash', './bin/push-docker', '-hub', "gcr.io/$PROJECT_ID", '-tag', "$TAG_NAME" ]
  id: "Upload container images"

timeout: 1800s
